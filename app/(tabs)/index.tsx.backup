import { useState, useEffect } from "react";
import {
  ScrollView,
  Text,
  View,
  TextInput,
  ActivityIndicator,
  Platform,
} from "react-native";
import * as Haptics from "expo-haptics";
import { ScreenContainer } from "@/components/screen-container";
import { useColors } from "@/hooks/use-colors";
import { router } from "expo-router";
import { trpc } from "@/lib/trpc";
import { AnimatedButton } from "@/components/animated-button";
import { AnimatedListItem } from "@/components/animated-list-item";
import {
  addCheckToHistory,
  updateProgressData,
  getCheckHistory,
  getProgressData,
  type CheckHistoryItem,
  type ProgressData,
} from "@/lib/storage";
import { getTodayReviewCount } from "@/services/review-service";

export default function HomeScreen() {
  const colors = useColors();
  const [sentence, setSentence] = useState("");
  const [isChecking, setIsChecking] = useState(false);
  const [recentChecks, setRecentChecks] = useState<CheckHistoryItem[]>([]);
  const [progress, setProgress] = useState<ProgressData | null>(null);
  const [todayReviewCount, setTodayReviewCount] = useState(0);

  // Load data on mount
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const history = await getCheckHistory();
    const progressData = await getProgressData();
    const reviewCount = await getTodayReviewCount();
    setRecentChecks(history.slice(0, 5));
    setProgress(progressData);
    setTodayReviewCount(reviewCount);
  };

  const checkGrammarMutation = trpc.grammar.check.useMutation({
    onSuccess: async (result) => {
      console.log("Grammar check success:", result);
      setIsChecking(false);
      if (Platform.OS !== "web") {
        Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
      }
      // Save to history and update progress
      await addCheckToHistory(result);
      await updateProgressData(result);
      await loadData();
      // Navigate to result screen with data
      router.push({
        pathname: "/check-result" as any,
        params: {
          result: JSON.stringify(result),
          gradeLevel: "9",
        },
      });
    },
    onError: (error) => {
      console.error("Grammar check failed:", error);
      setIsChecking(false);
      if (Platform.OS !== "web") {
        Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
      }
      
      // æ›´å‹å¥½çš„é”™è¯¯æç¤º
      let errorMessage = "è¯­æ³•æ£€æŸ¥å¤±è´¥";
      let errorDetail = "";
      
      if (error.message.includes("timeout") || error.message.includes("Timeout")) {
        errorDetail = "ç½‘ç»œè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•";
      } else if (error.message.includes("network") || error.message.includes("fetch")) {
        errorDetail = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®";
      } else if (error.message.includes("transform")) {
        errorDetail = "æœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•";
      } else {
        errorDetail = error.message || "æœªçŸ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";
      }
      
      alert(`${errorMessage}\n\n${errorDetail}\n\nğŸ’¡ æç¤ºï¼šå¦‚æœé—®é¢˜æŒç»­ï¼Œæˆ‘ä»¬ä¼šæä¾›åŸºç¡€æ£€æŸ¥åŠŸèƒ½`);
    },
  });

  const handleCheckGrammar = () => {
    console.log("handleCheckGrammar called");
    if (!sentence.trim()) {
      console.log("Sentence is empty");
      alert("è¯·è¾“å…¥ä¸€ä¸ªè‹±æ–‡å¥å­");
      return;
    }

    console.log("Checking sentence:", sentence.trim());

    if (Platform.OS !== "web") {
      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    }

    setIsChecking(true);
    console.log("Calling TRPC mutation...");
    checkGrammarMutation.mutate({
      sentence: sentence.trim(),
      gradeLevel: 9, // Default to grade 9, will be customizable later
    });
  };

  return (
    <ScreenContainer className="bg-background">
      <ScrollView contentContainerStyle={{ flexGrow: 1 }}>
        <View className="flex-1 p-6 gap-6">
          {/* Header - Minimal Logo + Slogan */}
          <View className="flex-row items-center justify-between pt-4 pb-2">
            <Text className="text-2xl font-light tracking-widest text-foreground">EPOS</Text>
            <Text className="text-sm font-light tracking-wide text-muted lowercase">logic of language</Text>
          </View>

          {/* Daily Tip Card */}
          <View className="bg-transparent rounded-none p-5 border-0.5 border-border">
            <View className="flex-row items-center gap-2 mb-2">
              <Text className="text-lg font-semibold text-primary">ğŸ’¡ æ¯æ—¥æç¤º</Text>
            </View>
            <Text className="text-sm text-foreground leading-relaxed">
              è®°ä½ï¼šè°ˆè®ºå·²å®Œæˆçš„åŠ¨ä½œæ—¶ä½¿ç”¨è¿‡å»æ—¶ã€‚ä¾‹å¦‚â€œI went to school yesterdayâ€è€Œä¸æ˜¯â€œI go to school yesterdayâ€
            </Text>
          </View>

          {/* Today's Review Reminder */}
          {todayReviewCount > 0 && (
            <AnimatedButton
              onPress={() => router.push("/wrong-book")}
              variant="secondary"
              className="bg-transparent border-0.5 border-border"
            >
              <View className="flex-row items-center justify-between py-1">
                <View className="flex-row items-center gap-3">
                  <View className="bg-error/20 rounded-full p-2">
                    <Text className="text-2xl">ğŸ””</Text>
                  </View>
                  <View>
                    <Text className="text-base font-bold text-foreground">
                      ä»Šæ—¥å¾…å¤ä¹ 
                    </Text>
                    <Text className="text-sm text-muted">
                      {todayReviewCount} ä¸ªé”™é¢˜å¾…å·©å›º
                    </Text>
                  </View>
                </View>
                <View className="bg-error rounded-full w-6 h-6 items-center justify-center">
                  <Text className="text-xs font-bold text-white">
                    {todayReviewCount}
                  </Text>
                </View>
              </View>
            </AnimatedButton>
          )}

         {/* æ‹ç…§è¯†åˆ«å…¥å£ */}
        <AnimatedButton
          onPress={() => router.push("/photo-recognition")}
          variant="secondary"
          className="bg-transparent border-0.5 border-border"
        >
          <View className="flex-row items-center justify-center gap-3 py-1">
            <View className="bg-primary/20 rounded-full p-2">
              <Text className="text-2xl">ğŸ“·</Text>
            </View>
            <Text className="text-lg font-semibold text-foreground">
              æ‹ç…§è¯†åˆ«
            </Text>
          </View>
        </AnimatedButton>

        {/* è¯¾æ–‡å¸¦å­¦å…¥å£ */}
        <AnimatedButton
          onPress={() => router.push("/textbook-reading-list")}
          variant="secondary"
          className="bg-transparent border-0.5 border-border"
        >
          <View className="flex-row items-center justify-center gap-3 py-1">
            <View className="bg-primary/20 rounded-full p-2">
              <Text className="text-2xl">ğŸ“–</Text>
            </View>
            <View>
              <Text className="text-lg font-semibold text-foreground">
                è¯¾æ–‡å¸¦å­¦
              </Text>
              <Text className="text-xs text-muted">
                æ™ºèƒ½ç‚¹è¯» Â· AIè€ƒç‚¹æ‹†è§£ Â· åœºæ™¯å¯¹ç»ƒ
              </Text>
            </View>
          </View>
        </AnimatedButton>

        {/* è¯­æ³•ä¸­å¿ƒå…¥å£ */}
        <AnimatedButton
          onPress={() => router.push("/grammar-center")}
          variant="secondary"
          className="bg-transparent border-0.5 border-border"
        >
          <View className="flex-row items-center justify-center gap-3 py-1">
            <View className="bg-green-500/20 rounded-full p-2">
              <Text className="text-2xl">ğŸ“š</Text>
            </View>
            <View>
              <Text className="text-lg font-semibold text-foreground">
                è¯­æ³•ä¸­å¿ƒ
              </Text>
              <Text className="text-xs text-muted">
                37ä¸ªçŸ¥è¯†ç‚¹ Â· æŒ‰å¹´çº§/ç±»åˆ«/è€ƒç‚¹ Â· æ™ºèƒ½å­¦ä¹ 
              </Text>
            </View>
          </View>
        </AnimatedButton>

        {/* è¾“å…¥åŒºåŸŸ */}
        <View className="bg-transparent rounded-none p-4 border-0.5 border-border gap-3">
          <Text className="text-lg font-semibold text-foreground">
            è¾“å…¥ä½ çš„å¥å­ï¼š
          </Text>
          <TextInput
              value={sentence}
              onChangeText={setSentence}
              placeholder="è¾“å…¥ä¸€ä¸ªè‹±æ–‡å¥å­è¿›è¡Œæ£€æŸ¥..."
              placeholderTextColor={colors.muted}
              multiline
              numberOfLines={4}
              returnKeyType="done"
              className="bg-background rounded-xl p-4 text-base text-foreground min-h-[120px]"
              style={{
                borderWidth: 1,
                borderColor: colors.border,
                textAlignVertical: "top",
              }}
            />

            {/* Check Button */}
            <AnimatedButton
              onPress={handleCheckGrammar}
              disabled={!sentence.trim() || isChecking}
              variant="primary"
            >
              {isChecking ? (
                <ActivityIndicator size="small" color="#fff" />
              ) : (
                <Text className="text-white font-semibold text-base">æ£€æŸ¥è¯­æ³•</Text>
              )}
            </AnimatedButton>
          </View>

          {/* Quick Stats */}
          <View className="flex-row gap-3">
            <View className="flex-1 bg-surface rounded-xl p-4 border border-border items-center">
              <Text className="text-2xl font-bold text-primary">{progress?.totalChecks || 0}</Text>
              <Text className="text-xs text-muted mt-1">å·²æ£€æŸ¥</Text>
            </View>
            <View className="flex-1 bg-surface rounded-xl p-4 border border-border items-center">
              <Text className="text-2xl font-bold text-success">{progress?.correctChecks || 0}</Text>
              <Text className="text-xs text-muted mt-1">æ­£ç¡®</Text>
            </View>
            <View className="flex-1 bg-surface rounded-xl p-4 border border-border items-center">
              <Text className="text-2xl font-bold text-warning">{progress?.currentStreak || 0}</Text>
              <Text className="text-xs text-muted mt-1">è¿ç»­å¤©æ•°</Text>
            </View>
          </View>

          {/* Recent Checks Section */}
          <View>
            <Text className="text-lg font-semibold text-foreground mb-3">æœ€è¿‘æ£€æŸ¥</Text>
            {recentChecks.length === 0 ? (
              <View className="bg-surface rounded-xl p-5 border border-border items-center">
                <Text className="text-sm text-muted">è¿˜æ²¡æœ‰æ£€æŸ¥è®°å½•</Text>
                <Text className="text-xs text-muted mt-1">åœ¨ä¸Šæ–¹å¼€å§‹æ£€æŸ¥ä½ çš„è¯­æ³•å§ï¼</Text>
              </View>
            ) : (
              <View className="gap-3">
                {recentChecks.map((item, index) => (
                  <AnimatedListItem key={item.id} index={index}>
                    <AnimatedButton
                      onPress={() => {
                        router.push({
                          pathname: "/check-result" as any,
                          params: {
                            result: JSON.stringify(item.result),
                            gradeLevel: "9",
                          },
                        });
                      }}
                      variant="secondary"
                      className="bg-surface border border-border p-0"
                    >
                      <View className="p-4 w-full">
                        <View className="flex-row items-center justify-between mb-2">
                          <Text
                            className="text-xs font-medium"
                            style={{
                              color: item.result.errors.length === 0 ? colors.success : colors.error,
                            }}
                          >
                            {item.result.errors.length === 0
                              ? "âœ“ å®Œç¾"
                              : `${item.result.errors.length} ä¸ªé”™è¯¯`}
                          </Text>
                          <Text className="text-xs text-muted">
                            {new Date(item.timestamp).toLocaleDateString("zh-CN")}
                          </Text>
                        </View>
                        <Text className="text-sm text-foreground" numberOfLines={2}>
                          {item.result.original}
                        </Text>
                      </View>
                    </AnimatedButton>
                  </AnimatedListItem>
                ))}
              </View>
            )}
          </View>
        </View>
      </ScrollView>
    </ScreenContainer>
  );
}
